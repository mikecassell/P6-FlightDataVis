<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="css/mystyles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
  <script type="text/javascript">
  	function draw(data) {
  		// Initial setup
		"use strict";
		var margin = 75,
			width = 1600 - margin,
			height = 800 - margin;

    // Adjustments for plotting the State Initials
    var mapAdj = { 'NJ':[22,10],'RI':[10,30],'DE':[20,15],'DC':[25,0],'MD':[55,-10],'FL':[20,-10],'LA':[-10,0],'MI':[0,20]};

    // Create Scales
		var colorScale = d3.scale.linear()
		    .domain([5, 12, 20])
		    .range(["green", "orange", "red"]);

		var colorMinScale = d3.scale.pow().exponent(2)
		    .domain([10, 18, 25])
		    .range(["green", "orange", "red"]);

    var busyScale = d3.scale.sqrt()
        .domain([500,10000])
        .range([2,8]);

    var flghtRad = d3.scale.sqrt()
       .domain([20000, 120000])
       .range([3, 12]);

    // Helper functions
    function key_func(d) {
                return d['key'];
            }

    d3.selection.prototype.moveToFront = function() {
        return this.each(function(){
            this.parentNode.appendChild(this);
        });
    };

    // Create the elements
		var svg = d3.select("body")
			.append("svg")
			.attr("width", width - margin)
			.attr("height", height - margin)
			.append('g')
			.attr('class', 'map');

		var projection = d3.geo.mercator()
							.scale(1200)
							.translate([width+1200, height + 465]);
							
    // Add a Legend and elements
    function addLegent() {
        svg.append('rect')
            .attr('x', width - 300)
            .attr('y', height - 425)
            .attr('width', 200)
            .attr('class', 'legend')
            .attr('height', 300);

        svg.append('text')
            .text('Legend')
            .attr('x', width - 240)
            .attr('y', height - 400)
            .style("font-size","24px")
            .style("font-family", "sans-serif")
            .style("fill", "black")
            .attr("text-anchor", "center");

        svg.append('circle')
            .attr('cx', width - 260)
            .attr('cy', height - 350)
            .attr('r', function(d) {
              return flghtRad(20000);
            });
        svg.append('circle')
            .attr('cx', width - 200)
            .attr('cy', height - 350)
            .attr('r', function(d) {
              return flghtRad(70000);
            });
        svg.append('circle')
            .attr('cx', width - 140)
            .attr('cy', height - 350)
            .attr('r', function(d) {
              return flghtRad(120000);
            });

        svg.append('text')
            .text('Low')
            .attr('x', width - 270)
            .attr('y', height - 315)
            .style("font-size","12px")
            .style("font-family", "sans-serif")
            .style("fill", "black")
            .attr("text-anchor", "center");

        svg.append('text')
            .text('Med')
            .attr('x', width - 212)
            .attr('y', height - 315)
            .style("font-size","12px")
            .style("font-family", "sans-serif")
            .style("fill", "black")
            .attr("text-anchor", "center");

        svg.append('text')
            .text('High')
            .attr('x', width - 152)
            .attr('y', height - 315)
            .style("font-size","12px")
            .style("font-family", "sans-serif")
            .style("fill", "black")
            .attr("text-anchor", "center");

        svg.append('line')
            .attr('x1', width - 140)
            .attr('y1', height - 300)
            .attr('x2', width - 140)
            .attr('y2', height - 250)
            .attr("stroke-width", function(d) {
                  return busyScale(20000);
              })
            .attr('stroke','Black')
            .attr('opacity','0.6');
        svg.append('line')
            .attr('x1', width - 200)
            .attr('y1', height - 300)
            .attr('x2', width - 200)
            .attr('y2', height - 250)
            .attr("stroke-width", function(d) {
                  return busyScale(10000);
              })
            .attr('stroke','Black')
            .attr('opacity','0.6');
        svg.append('line')
            .attr('x1', width - 260)
            .attr('y1', height - 300)
            .attr('x2', width - 260)
            .attr('y2', height - 250)
            .attr("stroke-width", function(d) {
                  return busyScale(2500);
              })
            .attr('stroke','Black')
            .attr('opacity','0.6');

        svg.append('text')
            .text('Flight Volumes')
            .attr('x', width - 245)
            .attr('y', height - 370)
            .style("font-size","14px")
            .style("font-family", "sans-serif")
            .style("fill", "black")
            .attr("text-anchor", "center");

        svg.append('text')
            .text('Flight Delays')
            .attr('x', width - 245)
            .attr('y', height - 200)
            .style("font-size","14px")
            .style("font-family", "sans-serif")
            .style("fill", "black")
            .attr("text-anchor", "center");

        svg.append('circle')
            .attr('cx', width - 260)
            .attr('cy', height - 180)
            .attr('fill', function(d) { return colorScale(0) })
            .attr('r', function(d) {
              return flghtRad(70000);
            });
        svg.append('circle')
            .attr('cx', width - 200)
            .attr('cy', height - 180)
            .attr('fill', function(d) { return colorScale(15) })
            .attr('r', function(d) {
              return flghtRad(70000);
            });
        svg.append('circle')
            .attr('cx', width - 140)
            .attr('cy', height - 180)
            .attr('fill', function(d) { return colorScale(30) })
            .attr('r', function(d) {
              return flghtRad(70000);
            });

        svg.append('text')
            .text('~5 Mins')
            .attr('x', width - 285)
            .attr('y', height - 150)
            .style("font-size","12px")
            .style("font-family", "sans-serif")
            .style("fill", "black")
            .attr('opacity', '0.65')
            .attr("text-anchor", "center");

        svg.append('text')
            .text('~12 Mins')
            .attr('x', width - 225)
            .attr('y', height - 150)
            .style("font-size","12px")
            .style("font-family", "sans-serif")
            .style("fill", "black")
            .attr('opacity', '0.65')
            .attr("text-anchor", "center");

        svg.append('text')
            .text('~20 Mins +')
            .attr('x', width - 165)
            .attr('y', height - 150)
            .style("font-size","12px")
            .style("font-family", "sans-serif")
            .style("fill", "black")
            .attr('opacity', '0.65')
            .attr("text-anchor", "center");
    }
    
    addLegent();
		var path = d3.geo.path().projection(projection, renderMap);
		
		// Map rendering
		function renderMap(stateData) {
			var map = svg.selectAll('path')
          .attr('class','stateShapes')
  				.data(stateData.features)
  				.enter()
  				.append('path')
  				.attr('d', path)
  				.style('fill', 'white')
  				.style('stroke', 'black')
  				.style('stroke-width', 0.5);
      d3.tsv("Data/us-state-names.tsv", function(tsv){
          var names = {};
          tsv.forEach(function(d,i){
            names[d.name] = d.code;
          });

          var names = svg.selectAll("text")
              .data(stateData.features)
              .enter()
              .append("g")
              .attr("class", "stateNames")
              .append("svg:text")
              .text(function(d){
                return names[d.properties.NAME];
              })
              .attr("x", function(d){
                  if(names[d.properties.NAME] in mapAdj) {
                      return path.centroid(d)[0] + mapAdj[names[d.properties.NAME]][0];
                  }
                  else {
                      return path.centroid(d)[0];
                  }
              })
              .attr("y", function(d){
                  if(names[d.properties.NAME] in mapAdj) {
                      return path.centroid(d)[1] + mapAdj[names[d.properties.NAME]][1];
                  }
                  else {
                      return path.centroid(d)[1];
                  }
              })
              .attr("text-anchor","middle")
              .attr("font-size","12");
      });

			plot_points(data);
		};
		// Line plotting functions for the intra-airport routes
		function plot_lines(data) {
      // Aggregation for routes
			function aggRoutes(leaves) {
        // Sum the flight data and mean coordinates
				var totalFlights = d3.sum(leaves, function(d) {
					return d["FlightCount"];
				});

				var arrDel = d3.sum(leaves, function(d) {
					return d["ArrDelay"];
				});

				var coords1 = leaves.map(function(d) {
					return projection([+d.LongOrigin, +d.LatOrigin])
				});

				var coords2 = leaves.map(function(d) {
					return projection([+d.LongDest, +d.LatDest])
				});

				var center_x1 = d3.mean(coords1, function(d) {
                    return d[0];
                });

                var center_y1 = d3.mean(coords1, function(d) {
                    return d[1];
                });
                var center_x2 = d3.mean(coords2, function(d) {
                    return d[0];
                });

                var center_y2 = d3.mean(coords2, function(d) {
                    return d[1];
                });
                return {
                  'meanDelay' : +arrDel / +totalFlights,
                  'totalFlights' : +totalFlights,
                  'x1' : center_x1,
                  'y1' : center_y1,
                  'x2' : center_x2,
                  'y2' : center_y2
                };
			}
      // Nest for the route aggregates
			var lineNest = d3.nest()
                				.key(function(d) { 
                					return d.Origin;
                				})
                				.key(function(d) {
                					return d.Dest;
                				})
                				.rollup(aggRoutes)
                				.entries(data);

      // Iterate through the 
      lineNest.forEach(function(source) {
        	svg.append('g').selectAll("path") // Sort to ensure smaller paths are on top of larger as default
              .data(source.values.sort(function(a, b) { 
                    return b.values['totalFlights'] - a.values['totalFlights'];
                }), key_func)
      		    .enter().append("path") // Append the paths
                	.attr("class", "path route src-" + source.key)
                  .attr('opacity','0.6')
                	.style("stroke", function(d) {
                      // scale line colors
                      return colorMinScale(d.values['meanDelay']);
                	})  
                  .attr("d", function(d) {
                  var dx = d.values['x2'] - d.values['x1'],
                      dy = d.values['y2']- d.values['y1'],
                      dr = Math.sqrt(dx * dx + dy * dy) * 2.5;
                  return "M" + d.values['x1'] + "," + d.values['y1'] + "A" + dr + "," + dr + " 0 0,1 " + d.values['x2'] + "," + d.values['y2'];
                  })
      		    .style("visibility", "hidden") // Hide the paths so we can just show the active ones
              .attr("stroke-width", function(d) {
                  // Scale the line widths
                  return busyScale(d.values['totalFlights']);
              })
              .on("mouseover", function(d) {
                  // Add the mouseover pop up to show flight data
                  div.transition()        
                      .duration(200)      
                      .style("opacity", .95);      
                  div.html("<b>Flights from " + this.classList[2].substring(4, 7) + " to " + d.key + "</b>" + 
                      "<br/>Total Flights: " + d.values.totalFlights  +
                      "<br/>Avg. Arrival Delay: " + (d.values.meanDelay).toFixed(0) + " minutes." )
                      .style("left", (d3.event.pageX + 20) + "px")     
                      .style("top", (d3.event.pageY - 10) + "px");
                  var sel = d3.select(this);
                  // Bring the active path to the front for visibility
                  sel.moveToFront();
              });
      });  
  }

		// Point plotting 
		function plot_points(data) {
            // Aggregate function for airports
            function agg_ports(leaves) {
                var total = d3.sum(leaves, function(d) {
                    return d['FlightCount'];
                });

                var airPortCode = d3.max(leaves, function(d) {
                    return d['Origin'];
                });

				var totalDelay = d3.sum(leaves, function(d) {
                	return d['DepDelay']
                }) 

                var lateFlights = d3.sum(leaves, function(d) {
                	return d['DelFlights']
                }) 

                var coords = leaves.map(function(d) {
                    return projection([+d.LongOrigin, +d.LatOrigin]);
                });

                var center_x = d3.mean(coords, function(d) {
                    return d[0];
                });

                var center_y = d3.mean(coords, function(d) {
                    return d[1];
                });

                return {
                  'Flights' : total,
                  'airPortCode': airPortCode,
                  'Late' : lateFlights,
                  'LateRate' : ((lateFlights / total ) * 100).toFixed(1) + "%",
                  'AvgDepDelay' : (totalDelay / total).toFixed(0),
                  'x' : center_x,
                  'y' : center_y
                };
            }

            // Create our nested data structure
            var nested = d3.nest()
                           .key(function(d) {
                            	return d['AirportNameOrigin'];
                           })
                           .rollup(agg_ports)
                           .entries(data);

            // Create the bubbles at the airports
            svg.append('g') // Append each airport as a bubble
               .attr("class", "bubble")
               .selectAll("circle")
               .data(nested)
               .enter()
               .append("circle")
               .text(function(d) { return d.key;})
               .attr('cx', function(d) { return d.values['x']; })
               .attr('cy', function(d) { return d.values['y']; })
               .attr('opacity','0.6')
               .attr('fill', function(d) { return colorScale(+d.values.AvgDepDelay) })
               .attr('r', function(d) {
                    // Scaling for radius based on flight counts
                    return flghtRad(d.values.Flights);
               })
               .on("mouseover", function(d) { // Adding the mouseover event to display airport data
          				div.transition()        
          					.duration(200)      
          					.style("opacity", .95);      
          				div.html("<b>" + d.key + "</b>" + 
          						"<br/>Total Departing Flights: " + d.values.Flights  +
          						"<br/>Delayed Departure Rate: " + d.values.LateRate + 
          						"<br/>Avg. Departing Delay: " + d.values.AvgDepDelay + " min") 
          					.style("left", (d3.event.pageX + 20) + "px")     
          				    .style("top", (d3.event.pageY - 10) + "px");
                      	})                  
      				.on("mouseout", function(d) { // Adding the mouseout events to hide display
        					div.transition()        
        						.duration(500)      
            					.style("opacity", 0);   
                		})
          		.on("click", function(d) { // Adding the onclick for the route lines
          			d3.selectAll(".route").transition().style("visibility","hidden");
          			var relevant = svg.selectAll(".src-" + d.values.airPortCode);
          			relevant.transition()
          				.style("visibility","visible");
          			testMe(d.values.airPortCode);
          		});
              	plot_lines(data);
        	}
				
        d3.json("data/gz_2010_us_040_00_5m.json", renderMap);

	};
  </script>
  <script type="text/javascript">
  	function testMe(d) {
  		// placeholder


  	}
  </script>
</head>
<body>
  <script type="text/javascript">
  	var div = d3.select("body").append("div")   
	    .attr("class", "tooltip")
	    .style("opacity", 0);

  	format = d3.time.format("%m/%d/%Y");

	d3.csv("data/flightData.csv", function(d) {
		d['FlightCount'] = +d['FlightCount'];
		d['DelFlights'] = +d['DelFlights'];
		d['DepDelay'] = +d['DepDelay'];
		d['LatOrigin'] = +d['LatOrigin'];
		d['LongOrigin'] = +d['LongOrigin'];
      	return d;
	}, draw);
  </script>
  <h1>Flight Delay Information for 2008</h1>
  <h2>Flight delay times for the top 20 US airports by volume of flights in 2008</h2>
  
  This information was compiled by RITA and represents all the air traffic between the 20 bussiest US airports in terms of departures in 2008 (the last year data was available for.) The purpose of the visualization is to show how visual encodings can make understanding complex and copious datasets quick and easy, giving the reader a quick understanding of flight delay performance for the year in the busiest airports. Click on an airport for detailed information and route data between that airport and the others.
  <br />
  <br />
</body>
</html>

</html>