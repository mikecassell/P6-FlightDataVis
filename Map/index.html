<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="css/mystyles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
  <script type="text/javascript">
  	function draw(data) {
  		// Initial setup
		"use strict";
		var margin = 75,
			width = 1600 - margin,
			height = 800 - margin;

		var colorScale = d3.scale.linear()
		    .domain([.12, .241])
		    .range(["green", "red"]);

		var colorMinScale = d3.scale.linear()
		    .domain([0, 20, 30])
		    .range(["green", "orange", "red"]);

    var busyScale = d3.scale.linear()
        .domain([500,5000])
        .range([2,10]);

		var svg = d3.select("body")
			.append("svg")
			.attr("width", width - margin)
			.attr("height", height - margin)
			.append('g')
			.attr('class', 'map');
		var projection = d3.geo.mercator()
							.scale(1200)
							.translate([width+1200, height + 465]);
							
		var path = d3.geo.path().projection(projection, renderMap);
		
		// Map rendering
		function renderMap(stateData) {
			var map = svg.selectAll('path')
				.data(stateData.features)
				.enter()
				.append('path')
				.attr('d', path)
				.style('fill', 'white')
				.style('stroke', 'black')
				.style('stroke-width', 0.5)
			plot_points(data);
		};
		
		function plot_lines(data) {
			function aggRoutes(leaves) {
				var totalFlights = d3.sum(leaves, function(d) {
					return d["FlightCount"];
				});

				var arrDel = d3.sum(leaves, function(d) {
					return d["ArrDelay"];
				});

				var coords1 = leaves.map(function(d) {
					return projection([+d.LongOrigin, +d.LatOrigin])
				});

				var coords2 = leaves.map(function(d) {
					return projection([+d.LongDest, +d.LatDest])
				});

				var center_x1 = d3.mean(coords1, function(d) {
                    return d[0];
                });

                var center_y1 = d3.mean(coords1, function(d) {
                    return d[1];
                });
                var center_x2 = d3.mean(coords2, function(d) {
                    return d[0];
                });

                var center_y2 = d3.mean(coords2, function(d) {
                    return d[1];
                });
                return {
                  'meanDelay' : +arrDel / +totalFlights,
                  'totalFlights' : +totalFlights,
                  'x1' : center_x1,
                  'y1' : center_y1,
                  'x2' : center_x2,
                  'y2' : center_y2
                };
			}

			var lineNest = d3.nest()
                				.key(function(d) { 
                					return d.Origin;
                				})
                				.key(function(d) {
                					return d.Dest;
                				})
                				.rollup(aggRoutes)
                				.entries(data);

	        lineNest.forEach(function(source) {
	        	svg.append('g').selectAll("path")
				    .data(source.values)
				    .enter().append("path")
	            	.attr("class", "path route src-" + source.key)
	            	.style("stroke", function(d) {
	            		return colorMinScale(d.values['meanDelay']);
	            	})  
                .attr("d", function(d) {
                var dx = d.values['x2'] - d.values['x1'],
                    dy = d.values['y2']- d.values['y1'],
                    dr = Math.sqrt(dx * dx + dy * dy) * 2.5;
                return "M" + d.values['x1'] + "," + d.values['y1'] + "A" + dr + "," + dr + " 0 0,1 " + d.values['x2'] + "," + d.values['y2'];
                })
				    .style("visibility","hidden")
            .attr("stroke-width", function(d) {
              return busyScale(d.values['totalFlights']);
            })
            .on("mouseover", function(d) {
                div.transition()        
                    .duration(200)      
                    .style("opacity", .95);      
                div.html("<b>Flights to " + d.key + "</b>" + 
                    "<br/>Total Flights: " + d.values.totalFlights  +
                    "<br/>Avg. Arrival Delay: " + (d.values.meanDelay).toFixed(0) + " minutes." )
                  .style("left", (d3.event.pageX + 20) + "px")     
                    .style("top", (d3.event.pageY - 10) + "px");
            });

	        	});
		}

		// Point plotting 
		function plot_points(data) {
            function agg_ports(leaves) {
                var total = d3.sum(leaves, function(d) {
                    return d['FlightCount'];
                });

                var airPortCode = d3.max(leaves, function(d) {
                    return d['Origin'];
                });

				var totalDelay = d3.sum(leaves, function(d) {
                	return d['DepDelay']
                }) 

                var lateFlights = d3.sum(leaves, function(d) {
                	return d['DelFlights']
                }) 

                var coords = leaves.map(function(d) {
                    return projection([+d.LongOrigin, +d.LatOrigin]);
                });

                var center_x = d3.mean(coords, function(d) {
                    return d[0];
                });

                var center_y = d3.mean(coords, function(d) {
                    return d[1];
                });

                return {
                  'Flights' : total,
                  'airPortCode': airPortCode,
                  'Late' : lateFlights,
                  'LateRate' : ((lateFlights / total ) * 100).toFixed(1) + "%",
                  'AvgDepDelay' : (totalDelay / total).toFixed(0) + " min",
                  'x' : center_x,
                  'y' : center_y
                };
            }

        	
            // Create our nested data structure
            var nested = d3.nest()
                           .key(function(d) {
                            	return d['AirportNameOrigin'];
                           })
                           .rollup(agg_ports)
                           .entries(data);

            // Set up scaling for bubble sizes by getting the max and then creating a scale
			var maxFlights  = d3.max(nested, function(d) {
                return d.values['Flights'];
            });

			var flghtRad = d3.scale.sqrt()
                           .domain([0, maxFlights])
                           .range([0, 10]);

            // Create the bubbles at the airports
            svg.append('g')
               .attr("class", "bubble")
               .selectAll("circle")
               .data(nested)
               .enter()
               .append("circle")
               .text(function(d) { return d.key;})
               .attr('cx', function(d) { return d.values['x']; })
               .attr('cy', function(d) { return d.values['y']; })
               .attr('fill', function(d) { return colorScale(+d.values.Late / d.values.Flights) })
               .attr('r', function(d) {
                    return flghtRad(d.values.Flights);
               })
               .on("mouseover", function(d) {      
          				div.transition()        
          					.duration(200)      
          					.style("opacity", .95);      
          				div.html("<b>" + d.key + "</b>" + 
          						"<br/>Total Departing Flights: " + d.values.Flights  +
          						"<br/>Delayed Departure Rate: " + d.values.LateRate + 
          						"<br/>Avg. Departing Delay: " + d.values.AvgDepDelay) 
          					.style("left", (d3.event.pageX + 20) + "px")     
          				    .style("top", (d3.event.pageY - 10) + "px");
                      	})                  
      				.on("mouseout", function(d) {       
        					div.transition()        
        						.duration(500)      
            					.style("opacity", 0);   
                		})
          		.on("click", function(d) {
                debugger;
          			d3.selectAll(".route").transition().style("visibility","hidden");
          			var relevant = svg.selectAll(".src-" + d.values.airPortCode);
          			relevant.transition()
          				.style("visibility","visible");
          			testMe(d.values.airPortCode);
          		});
              	plot_lines(data);
        	}
				
        d3.json("data/gz_2010_us_040_00_5m.json", renderMap);

       
	};
  </script>
  <script type="text/javascript">
  	function testMe(d) {
  		// placeholder


  	}
  </script>
</head>
<body>
  <script type="text/javascript">
  	var div = d3.select("body").append("div")   
	    .attr("class", "tooltip")
	    .style("opacity", 0);

  	format = d3.time.format("%m/%d/%Y");

	d3.csv("data/flightData.csv", function(d) {
		d['FlightCount'] = +d['FlightCount'];
		d['DelFlights'] = +d['DelFlights'];
		d['DepDelay'] = +d['DepDelay'];
		d['LatOrigin'] = +d['LatOrigin'];
		d['LongOrigin'] = +d['LongOrigin'];
      	return d;
	}, draw);
  </script>
  <h1>Flight Delay Information for 2008</h1>
  <h2>Flight delay times for the top 20 US airports by volume of flights in 2008</h2>
  
  This information was compiled by TODO:Name and represents all the air traffic between the 20 bussiest US airports for domestic flights in 2008 (the last year data was available for.) The size of each airports circle represents its departing volume for the year (proportionally) and the color is shaded from green to red representing the mean departure delay for a flight from that airport. Hovering over an airport will provide a quick summary of departure information (delays and flight volume). Lastly clicking will provide additional route data documenting the arrival delays to the other airports from the one clicked (so you can compare the depature delays in the circles vs. the arrival delays in the routes to see where the bottlenecks are).
<br />
<br />
  If you could take a few minutes to provide me feedback on the below points (or anything else that stands out), I would be very grateful for it (I need feedback to finish my course!)
    <li>What do you notice in the visualization?</li>
    <li>What questions do you have about the data?</li>
    <li>What relationships do you notice?</li>
    <li>What do you think is the main takeaway from this visualization?</li>
    <li>Is there something you donâ€™t understand in the graphic?</li>
  <br />
</body>
</html>

</html>